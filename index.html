<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Quiz San Valent√≠n - Crea tu Quiz Personalizado</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíñ</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <!-- ================================================
         HTML - SECCI√ìN HOME / LANDING
         ================================================ -->
    <section id="landing" class="section active">
        <div class="landing-container">
            <div class="logo">üíù</div>
            <h1>Crea tu Quiz San Valent√≠n</h1>
            <p class="subtitle">
                Crea un quiz personalizado para esa persona especial.
                ¬°Comparte el link y descubre qu√© tanto te conoce!
            </p>
            
            <div class="button-group">
                <button class="btn btn-demo" onclick="mostrarSeccion('quiz')">
                    <span>Ver Demo</span>
                </button>
                
                <button class="btn btn-create" onclick="mostrarSeccion('registro')">
                    <span>Crear cuenta</span>
                </button>
                
                <button class="btn btn-login" onclick="irALogin()">
                    <span>Iniciar sesi√≥n</span>
                </button>
            </div>
            
            <div class="features">
                <h3>‚ú® ¬øQu√© incluye?</h3>
                <ul class="feature-list">
                    <li>10 preguntas personalizadas</li>
                    <li>Link √∫nico para compartir</li>
                    <li>V√°lido para siempre</li>
                </ul>
            </div>
            
            <div class="footer">
                üíò Especial San Valent√≠n 2026
            </div>
        </div>
    </section>

    <!-- ================================================
         HTML - SECCI√ìN QUIZ DEMO
         ================================================ -->
    <section id="quiz" class="section">
        <!-- Contenedor principal - Formato 9:16 con fondo de imagen -->
        <div class="container">
            
            <!-- ==========================================
                 SECCI√ìN 1: PANTALLA DE BIENVENIDA
                 - Muestra dedicatoria personal
                 - Bot√≥n para iniciar el quiz
                 ========================================== -->
            <section id="bienvenida" class="seccion active">
                <!-- Pantalla de carga para quiz personalizado -->
                <div id="loading-quiz" class="loading-quiz-overlay">
                    <div class="loading-quiz-content">
                        <div class="spinner"></div>
                        <p>Cargando tu quiz personalizado...</p>
                    </div>
                </div>
                
                <div class="contenido">
                    <!-- T√≠tulo y dedicatoria en box blanca con efecto de flotaci√≥n -->
                    <div class="titulo-box">
                        <h1>üíò Para Ti üíò</h1>
                        <p class="dedicatoria">Rhi</p>
                    </div>
                    <!-- Textos descriptivos -->
                    <p class="descripcion">Prepar√© este quiz especial para ti</p>
                    <p class="descripcion">¬øQu√© tanto me conoces?</p>
                    <!-- Bot√≥n principal para iniciar -->
                    <button id="btn-empezar" class="btn-principal">¬°Empezar!</button>
                    <button id="btn-volver-bienvenida" onclick="mostrarSeccion('landing')" class="btn-secundario" style="margin-top: 15px;">‚Üê Volver al inicio</button>
                </div>
            </section>

            <!-- ==========================================
                 SECCI√ìN 2: PREGUNTAS DEL QUIZ
                 - Preguntas din√°micas con contador
                 - Opciones de respuesta A, B, C
                 ========================================== -->
            <section id="pregunta" class="seccion">
                <!-- N√∫mero de pregunta en la esquina del fondo -->
                <div class="numero-pregunta">1</div>
                <!-- Contador de tiempo -->
                <div class="contador-tiempo">
                    <svg class="cronometro-svg" viewBox="0 0 100 100">
                        <circle class="cronometro-fondo" cx="50" cy="50" r="45"></circle>
                        <circle class="cronometro-progreso" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <span class="tiempo-numero">10</span>
                </div>
                <div class="contenido-quiz">
                    <!-- Texto de la pregunta -->
                    <div class="pregunta-box">
                        <h2 class="pregunta-texto">¬øD√≥nde fue nuestra primera cita?</h2>
                    </div>
                    <!-- Opciones de respuesta -->
                    <div class="opciones">
                        <button class="opcion-btn" data-respuesta="A">
                            <span class="letra">A</span>
                            <span class="texto">Un restaurante</span>
                        </button>
                        <button class="opcion-btn" data-respuesta="B">
                            <span class="letra">B</span>
                            <span class="texto">En casa</span>
                        </button>
                        <button class="opcion-btn" data-respuesta="C">
                            <span class="letra">C</span>
                            <span class="texto">Otro lugar especial</span>
                        </button>
                    </div>
                    <!-- √Årea inferior: Puntaje y bot√≥n siguiente -->
                    <div class="quiz-footer">
                        <div class="puntaje">
                            <span class="puntaje-label">Puntaje:</span>
                            <span class="puntaje-numero">0</span>
                        </div>
                        <button id="btn-siguiente" class="btn-siguiente">Siguiente</button>
                    </div>
                </div>
            </section>

            <!-- ==========================================
                 SECCI√ìN 3: RESULTADOS FINALES
                 - Muestra puntaje total
                 - Mensaje personalizado
                 - Bot√≥n para reiniciar
                 ========================================== -->
            <section id="resultados" class="seccion">
                <div class="contenido">
                    <div class="resultados-box">
                        <h1 class="titulo-resultado">¬°Terminaste! üéâ</h1>
                        <div class="puntaje-final">
                            <span class="puntaje-final-numero">0</span>
                            <span class="puntaje-final-total">/ 100</span>
                        </div>
                        <p class="mensaje-resultado">¬°Excelente trabajo!</p>
                        <p class="intento-numero" style="font-size: 14px; opacity: 0.8; margin-top: 15px;"></p>
                        <button id="btn-reiniciar" class="btn-principal">Jugar de nuevo</button>
                        <button id="btn-volver-resultados" onclick="mostrarSeccion('landing')" class="btn-secundario" style="margin-top: 15px;">‚Üê Volver al inicio</button>
                    </div>
                </div>
            </section>

        </div>

        <!-- Audio del quiz -->
        <audio id="audio-quiz" src="assets/shallow.mp3"></audio>
    </section>

    <!-- ================================================
         HTML - SECCI√ìN LOGIN
         ================================================ -->
    <section id="login" class="section">
        <div class="login-container">
            <a class="back-btn-login" onclick="mostrarSeccion('landing')">‚Üê Volver</a>
            
            <div class="header-login">
                <h1>Iniciar Sesi√≥n üîë</h1>
                <p class="subtitle">Accede con tu correo electr√≥nico</p>
            </div>
            
            <div class="error-message" id="errorMessageLogin"></div>
            <div class="loading" id="loadingLogin">
                <div class="spinner"></div>
                <p>Verificando...</p>
            </div>
            
            <form id="form-login">
                <div class="form-group">
                    <label for="email-login">Correo Electr√≥nico *</label>
                    <input type="email" id="email-login" required placeholder="tu@email.com">
                </div>
                
                <div class="info-message">
                    üí° Usa el email que registraste al crear tu cuenta.
                </div>
                
                <button type="submit" class="btn">Iniciar Sesi√≥n ‚Üí</button>
            </form>
            
            <div class="register-link">
                ¬øNo tienes cuenta? <a onclick="mostrarSeccion('registro')">Reg√≠strate aqu√≠</a>
            </div>
        </div>
    </section>

    <!-- ================================================
         HTML - SECCI√ìN REGISTRO
         ================================================ -->
    <section id="registro" class="section">
        <div class="registro-container">
            <a class="back-btn-registro" onclick="mostrarSeccion('landing')">‚Üê Volver</a>
            
            <div class="header-registro">
                <h1>Crear Mi Quiz üíù</h1>
                <p class="subtitle">Completa los 3 pasos para crear tu quiz personalizado</p>
            </div>
            
            <div class="step-indicator">
                <div class="step active" id="step1-indicator-reg">
                    <div class="step-circle">1</div>
                    <div class="step-label">Datos</div>
                </div>
                <div class="step" id="step2-indicator-reg">
                    <div class="step-circle">2</div>
                    <div class="step-label">Pago</div>
                </div>
                <div class="step" id="step3-indicator-reg">
                    <div class="step-circle">3</div>
                    <div class="step-label">Confirmaci√≥n</div>
                </div>
            </div>
            
            <div class="error-message" id="errorMessageReg"></div>
            <div class="loading" id="loadingReg">
                <div class="spinner"></div>
                <p>Procesando...</p>
            </div>
            
            <!-- PASO 1: Datos Personales -->
            <div class="form-section active" id="paso1-reg">
                <form id="form-datos-reg">
                   <div class="form-group">
                        <label for="nombre-reg">Tu Nombre *</label>
                        <input type="text" id="nombre-reg" required placeholder="Ej: Carlos">
                    </div>
                    
                    <div class="form-group">
                        <label for="email-reg">Tu Email *</label>
                        <input type="email" id="email-reg" required placeholder="tu@email.com">
                    </div>
                    
                    <button type="submit" class="btn">Continuar al Pago ‚Üí</button>
                </form>
            </div>
            
            <!-- PASO 2: Informaci√≥n de Pago -->
            <div class="form-section" id="paso2-reg">
                <div class="payment-info">
                    <h3>üí≥ Informaci√≥n de Pago</h3>
                    <p><strong>Precio:</strong> S/ 10.00 (Promo San Valent√≠n)</p>
                    <p><strong>Yape:</strong> 987654321</p>
                    <p><strong>BCP:</strong> 19X-XXXXXXX-X-XX</p>
                    <p style="margin-top: 10px;">Realiza la transferencia y sube tu comprobante</p>
                </div>
                
                <form id="form-pago-reg">
                    <div class="form-group">
                        <label for="metodo-pago-reg">M√©todo de Pago *</label>
                        <select id="metodo-pago-reg" required>
                            <option value="">Selecciona...</option>
                            <option value="yape">Yape</option>
                            <option value="transferencia">Transferencia Bancaria</option>
                            <option value="plin">Plin</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero-operacion-reg">N√∫mero de Operaci√≥n *</label>
                        <input type="text" id="numero-operacion-reg" required placeholder="Ej: 0012345678">
                    </div>
                    
                    <div class="form-group">
                        <label>Comprobante de Pago *</label>
                        <div class="file-upload" onclick="document.getElementById('comprobante-reg').click()">
                            <input type="file" id="comprobante-reg" accept="image/*" required>
                            <div class="file-upload-label">üì∏ Click para subir captura</div>
                            <div class="file-name" id="fileName-reg">JPG, PNG - M√°x 5MB</div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="volverPaso1Reg()">‚Üê Atr√°s</button>
                    <button type="submit" class="btn">Confirmar y Continuar ‚Üí</button>
                </form>
            </div>
            
            <!-- PASO 3: Confirmaci√≥n -->
            <div class="form-section" id="paso3-reg">
                <div class="success-message">
                    <h2>¬°Pago Aprobado! ‚úÖ üíñ</h2>
                    <p style="margin: 15px 0;">Tu cuenta ha sido creada correctamente y tu pago fue verificado.</p>
                    <p style="margin-top: 20px; font-size: 0.95rem;">
                        ¬°Todo listo! üéâ Ya puedes iniciar sesi√≥n para crear tu quiz personalizado.
                    </p>
                </div>
                
                <button class="btn" onclick="irALoginDesdeRegistro()">Iniciar Sesi√≥n</button>
            </div>
        </div>
    </section>

    <!-- ================================================
         HTML - SECCI√ìN CREAR PREGUNTAS
         ================================================ -->
    <section id="crear-preguntas" class="section">
        <div class="crear-container">
            <!-- PANTALLA DE CARGA INICIAL -->
            <div class="loading show" id="loadingInicial">
                <div class="spinner"></div>
                <p>Verificando acceso...</p>
            </div>
            
            <!-- ERROR DE ACCESO -->
            <div class="error-message" id="errorAcceso">
                <strong>‚ö†Ô∏è Acceso no autorizado</strong>
                <p id="errorAccesoTexto"></p>
                <button class="btn" onclick="mostrarSeccion('landing')">Volver al Inicio</button>
            </div>
            
            <!-- FORMULARIO DE PREGUNTAS -->
            <div id="formularioPreguntas" style="display: none;">
                <div class="header-crear">
                    <h1>Crea tus 10 Preguntas üíù</h1>
                    <p class="subtitle">
                        Personaliza tu quiz con preguntas que solo esa persona especial podr√° responder correctamente.
                    </p>
                </div>
                
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0 de 10 completadas</div>
                
                <form id="formPreguntas">
                    <!-- Campo para nombre del destinatario -->
                    <div class="pregunta-card" style="background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%); border: 2px solid #667eea;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <span style="font-size: 2rem;">üíù</span>
                        </div>
                        <div class="form-group">
                            <label style="text-align: center; color: #667eea; font-size: 1.1rem;">¬øPara qui√©n es este quiz? *</label>
                            <input type="text" id="nombre-destinatario" required placeholder="Ej: Mar√≠a, Carlos, mi amor..." style="text-align: center; font-size: 1.1rem; font-weight: 600;">
                            <p style="text-align: center; color: #999; font-size: 0.85rem; margin-top: 8px;">Este nombre aparecer√° en la pantalla de bienvenida del quiz</p>
                        </div>
                    </div>
                    
                    <div id="preguntasContainer"></div>
                    
                    <button type="submit" class="btn" id="btnGuardar">
                        Guardar Quiz y Obtener Link üéâ
                    </button>
                </form>
            </div>
            
            <!-- PANTALLA DE √âXITO -->
            <div class="success-screen" id="successScreen">
                <div class="success-icon">üéâ</div>
                <h1 style="color: #667eea; margin-bottom: 15px;">¬°Quiz Creado Exitosamente!</h1>
                <p style="color: #666; margin-bottom: 25px;">
                    Tu quiz personalizado est√° listo. Comparte este link con esa persona especial:
                </p>
                
                <div class="link-box">
                    <h3>üîó Tu Link √önico</h3>
                    <div class="link-display" id="linkFinal"></div>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="copiarLink()">
                            üìã Copiar Link
                        </button>
                        <button class="btn btn-secondary" onclick="compartirWhatsApp()">
                            üí¨ WhatsApp
                        </button>
                    </div>
                </div>
                
                <p style="color: #999; font-size: 0.9rem; margin-top: 20px;">
                    üí° Guarda este link en un lugar seguro. Podr√°s compartirlo las veces que quieras.
                </p>
                
                <button class="btn" onclick="mostrarSeccion('landing')" style="margin-top: 30px;">
                    Volver al Inicio
                </button>
            </div>
        </div>
    </section>

    <!-- ================================================
         SCRIPTS - NAVEGACI√ìN Y FUNCIONALIDAD
         ================================================ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        /* ================================================
           FUNCIONES UTILITARIAS GLOBALES
           ================================================ */
        
        // Funci√≥n gen√©rica para mostrar errores
        function mostrarError(elementId, mensaje, timeout = 5000) {
            const errorDiv = document.getElementById(elementId);
            if (!errorDiv) return;
            errorDiv.textContent = mensaje;
            errorDiv.classList.add('show');
            if (timeout > 0) {
                setTimeout(() => errorDiv.classList.remove('show'), timeout);
            }
        }
        
        // Funci√≥n gen√©rica para ocultar errores
        function ocultarError(elementId) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) errorDiv.classList.remove('show');
        }
        
        // Funci√≥n gen√©rica para mostrar/ocultar loading
        function toggleLoading(elementId, show) {
            const loading = document.getElementById(elementId);
            if (!loading) return;
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }
        
        /* ================================================
           SCRIPTS GLOBALES - Navegaci√≥n entre secciones
           ================================================ */
        
        function mostrarSeccion(seccionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Limpiar sessionStorage si se vuelve al landing desde cualquier lugar
            if (seccionId === 'landing') {
                sessionStorage.removeItem('currentQuizCode');
            }
            
            // Mostrar la secci√≥n seleccionada
            const seccion = document.getElementById(seccionId);
            if (seccion) {
                seccion.classList.add('active');
                
                // Si es la secci√≥n quiz, inicializar el quiz con preguntas.json
                if (seccionId === 'quiz') {
                    iniciarQuizDemo();
                }
                
                // Si es la secci√≥n crear-preguntas, inicializar creaci√≥n de preguntas
                if (seccionId === 'crear-preguntas') {
                    inicializarCrearPreguntas();
                }
                
                // Si es la secci√≥n registro, inicializar formulario de registro
                if (seccionId === 'registro') {
                    inicializarRegistro();
                }
                
                // Si es la secci√≥n login, inicializar formulario de login
                if (seccionId === 'login') {
                    inicializarLogin();
                }
                
                // Scroll al top
                window.scrollTo(0, 0);
            }
        }
        
        function irALogin() {
            mostrarSeccion('login');
        }
        
        // Detectar hash en URL al cargar la p√°gina
        window.addEventListener('load', () => {
            const hash = window.location.hash.substring(1); // Eliminar el #
            if (hash) {
                // Extraer secci√≥n del hash (ej: "crear-preguntas?code=XXX" -> "crear-preguntas")
                const seccionId = hash.split('?')[0];
                if (seccionId && document.getElementById(seccionId)) {
                    mostrarSeccion(seccionId);
                }
            }
        });
        
        // Detectar cambios de hash durante la navegaci√≥n
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const seccionId = hash.split('?')[0];
                if (seccionId && document.getElementById(seccionId)) {
                    mostrarSeccion(seccionId);
                }
            }
        });
        
        /* ================================================
           SCRIPTS QUIZ - L√≥gica del quiz con preguntas.json
           ================================================ */
        
        // Variables globales del quiz
        let preguntasDemo = [];
        let preguntaActual = 0;
        let puntaje = 0;
        let tiempoRestante = 10;
        let timerInterval = null;
        let tiempos = [];
        let respuestasUsuario = [];
        
        // Variables para text-to-speech
        let vocesDisponibles = [];
        let vocesListas = false;
        const SPEECH_AVAILABLE = 'speechSynthesis' in window;
        
        // ================================================
        // SISTEMA TEXT-TO-SPEECH
        // ================================================
        
        // Funci√≥n para cargar voces disponibles
        function cargarVoces() {
            if (!SPEECH_AVAILABLE) return;
            
            vocesDisponibles = window.speechSynthesis.getVoices();
            
            if (vocesDisponibles.length > 0) {
                vocesListas = true;
                console.log('‚úÖ Voces cargadas:', vocesDisponibles.length);
                
                // Mostrar voces en espa√±ol disponibles
                const vocesEspanol = vocesDisponibles.filter(v => v.lang.includes('es'));
                if (vocesEspanol.length > 0) {
                    console.log('üó£Ô∏è Voces en espa√±ol:', vocesEspanol.map(v => v.name).join(', '));
                }
            } else {
                console.log('‚è≥ Esperando voces...');
            }
        }
        
        // Cargar voces disponibles
        if (SPEECH_AVAILABLE) {
            setTimeout(cargarVoces, 100);
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = cargarVoces;
            }
        } else {
            console.warn('Web Speech API no disponible en este navegador');
        }
        
        // Funci√≥n para leer texto con voz
        function leerTexto(texto) {
            // Validar entrada
            if (!texto || typeof texto !== 'string' || texto.trim() === '') {
                console.warn('Texto inv√°lido para s√≠ntesis de voz');
                return;
            }
            
            // Verificar disponibilidad de Speech API
            if (!SPEECH_AVAILABLE) {
                console.log('TTS no disponible:', texto);
                return; // Silenciosamente no hacer nada
            }
            
            try {
                // Cancelar cualquier s√≠ntesis en progreso
                window.speechSynthesis.cancel();
                
                setTimeout(() => {
                    try {
                        const utterance = new SpeechSynthesisUtterance(texto);
                        utterance.lang = 'es-ES';
                        utterance.rate = 1.0;
                        utterance.pitch = 1.2;
                        utterance.volume = 1;
                        
                        // Manejador de errores para utterance
                        utterance.onerror = (event) => {
                            // Ignorar error "interrupted" porque es normal
                            if (event.error === 'interrupted') {
                                return;
                            }
                            // Solo mostrar otros errores reales
                            if (event.error !== 'canceled') {
                                console.warn('‚ö†Ô∏è Error en s√≠ntesis de voz:', event.error);
                            }
                        };
                        
                        // Manejador de inicio
                        utterance.onstart = () => {
                            console.log('üì¢ Leyendo:', texto.substring(0, 50) + '...');
                        };
                        
                        // Obtener voces actualizadas
                        let voices = window.speechSynthesis.getVoices();
                        
                        // Si no hay voces, intentar recargar
                        if (!voices || voices.length === 0) {
                            console.log('Recargando voces...');
                            cargarVoces();
                            voices = window.speechSynthesis.getVoices();
                        }
                        
                        if (voices && voices.length > 0) {
                            // Buscar espec√≠ficamente voz de Google Espa√±ol
                            const vozGoogle = voices.find(voice => 
                                voice.name.toLowerCase().includes('google') && 
                                (voice.lang.includes('es') || voice.name.toLowerCase().includes('espa√±ol') || voice.name.toLowerCase().includes('spanish'))
                            );
                            
                            // Si no encuentra Google, buscar cualquier voz en espa√±ol
                            const vozEspanol = voices.find(voice => voice.lang.includes('es'));
                            
                            if (vozGoogle) {
                                utterance.voice = vozGoogle;
                                console.log('üó£Ô∏è Usando voz:', vozGoogle.name);
                            } else if (vozEspanol) {
                                utterance.voice = vozEspanol;
                                console.log('üó£Ô∏è Usando voz:', vozEspanol.name);
                            } else {
                                console.log('üó£Ô∏è Usando voz por defecto');
                            }
                        } else {
                            console.warn('‚ö†Ô∏è No se encontraron voces disponibles');
                        }
                        
                        window.speechSynthesis.speak(utterance);
                    } catch (error) {
                        console.warn('Error al leer:', error);
                    }
                }, 100);
            } catch (error) {
                console.warn('Error en leerTexto:', error);
            }
        }
        
        async function iniciarQuizDemo() {
            // Preguntas por defecto (en caso de que falle el fetch)
            const preguntasDefault = [
                {
                    pregunta: "¬øD√≥nde fue nuestra primera cita?",
                    opciones: { A: "Un restaurante", B: "En casa", C: "Kantrika" },
                    correcta: "C"
                },
                {
                    pregunta: "¬øCu√°l es mi color favorito?",
                    opciones: { A: "Negro", B: "Rojo", C: "Verde" },
                    correcta: "A"
                },
                {
                    pregunta: "¬øCu√°l es nuestra canci√≥n favorita?",
                    opciones: { A: "Un reguet√≥n", B: "Una canci√≥n pop", C: "Una canci√≥n de rock" },
                    correcta: "A"
                },
                {
                    pregunta: "¬øQu√© me gusta hacer en mi tiempo libre?",
                    opciones: { A: "Leer libros", B: "Estudiar", C: "Ver pel√≠culas" },
                    correcta: "B"
                },
                {
                    pregunta: "¬øCu√°l es mi comida favorita?",
                    opciones: { A: "Pizza", B: "Pasta", C: "Pollo" },
                    correcta: "C"
                },
                {
                    pregunta: "¬øQu√© lugar prefiero para vacacionar?",
                    opciones: { A: "La playa", B: "La monta√±a", C: "La ciudad" },
                    correcta: "A"
                },
                {
                    pregunta: "¬øCu√°l es mi serie favorita?",
                    opciones: { A: "Una comedia", B: "Un drama", C: "Acci√≥n" },
                    correcta: "B"
                },
                {
                    pregunta: "¬øQu√© tipo de m√∫sica prefiero?",
                    opciones: { A: "Pop", B: "Rock", C: "Reguet√≥n" },
                    correcta: "C"
                },
                {
                    pregunta: "¬øCu√°l es mi forma favorita de relajarme?",
                    opciones: { A: "Leer", B: "Dormir", C: "Ver TV" },
                    correcta: "B"
                },
                {
                    pregunta: "¬øQu√© valoro m√°s en una relaci√≥n?",
                    opciones: { A: "Confianza", B: "Diversi√≥n", C: "Comunicaci√≥n" },
                    correcta: "A"
                }
            ];
            
            // Verificar si hay un c√≥digo de quiz en la URL
            const hash = window.location.hash; // Ej: #quiz?code=ABC123
            const urlParams = new URLSearchParams(hash.split('?')[1] || '');
            const quizCode = urlParams.get('code');
            
            // Mostrar loading y ocultar botones "Volver al inicio" si hay c√≥digo de quiz personalizado
            const loadingQuiz = document.getElementById('loading-quiz');
            const btnVolverBienvenida = document.getElementById('btn-volver-bienvenida');
            const btnVolverResultados = document.getElementById('btn-volver-resultados');
            
            if (quizCode) {
                if (loadingQuiz) {
                    loadingQuiz.classList.add('show');
                }
                // Ocultar botones de volver al inicio en quiz personalizado
                if (btnVolverBienvenida) btnVolverBienvenida.style.display = 'none';
                if (btnVolverResultados) btnVolverResultados.style.display = 'none';
            }
            
            if (quizCode) {
                // Cargar preguntas personalizadas desde Supabase
                console.log('üîç Cargando preguntas personalizadas con c√≥digo:', quizCode);
                try {
                    // Verificar que supabaseQuiz est√© disponible
                    if (typeof supabaseQuiz === 'undefined') {
                        throw new Error('Supabase no est√° configurado');
                    }
                    
                    const preguntasPersonalizadas = await supabaseQuiz.obtenerPreguntasPorCodigo(quizCode);
                    
                    if (preguntasPersonalizadas && preguntasPersonalizadas.length > 0) {
                        // Las preguntas ya vienen en el formato correcto desde Supabase
                        preguntasDemo = preguntasPersonalizadas;
                        console.log('‚úÖ Preguntas personalizadas cargadas:', preguntasDemo.length);
                        
                        // Cargar el nombre del destinatario
                        const usuario = await supabaseQuiz.obtenerUsuarioPorCodigo(quizCode);
                        if (usuario && usuario.nombre_destinatario) {
                            // Actualizar el nombre en la pantalla de bienvenida
                            const dedicatoriaElement = document.querySelector('#quiz .dedicatoria');
                            if (dedicatoriaElement) {
                                dedicatoriaElement.textContent = usuario.nombre_destinatario;
                            }
                        }
                        
                        // Ocultar loading cuando los datos est√©n listos
                        if (loadingQuiz) {
                            loadingQuiz.classList.remove('show');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è No se encontraron preguntas para el c√≥digo:', quizCode);
                        preguntasDemo = preguntasDefault;
                        // Ocultar loading si no hay preguntas
                        if (loadingQuiz) {
                            loadingQuiz.classList.remove('show');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando preguntas personalizadas:', error);
                    preguntasDemo = preguntasDefault;
                    // Ocultar loading si hay error
                    if (loadingQuiz) {
                        loadingQuiz.classList.remove('show');
                    }
                }
            } else {
                // Intentar cargar preguntas desde preguntas.json (modo demo)
                try {
                    const response = await fetch('preguntas.json');
                    const data = await response.json();
                    preguntasDemo = data.preguntas;
                    console.log('‚úÖ Preguntas cargadas desde preguntas.json');
                } catch (error) {
                    console.warn('‚ö†Ô∏è No se pudo cargar preguntas.json, usando preguntas por defecto');
                    preguntasDemo = preguntasDefault;
                }
            }
            
            // Resetear variables
            preguntaActual = 0;
            puntaje = 0;
            tiempos = [];
            respuestasUsuario = [];
            
            // Mostrar pantalla de bienvenida del quiz
            document.querySelector('#quiz #bienvenida').classList.add('active');
            document.querySelector('#quiz #pregunta').classList.remove('active');
            document.querySelector('#quiz #resultados').classList.remove('active');
            
            // Configurar botones
            document.getElementById('btn-empezar').onclick = empezarQuizDemo;
            document.getElementById('btn-reiniciar').onclick = reiniciarQuizDemo;
            
            // Configurar bot√≥n siguiente
            const btnSiguiente = document.getElementById('btn-siguiente');
            if (btnSiguiente) {
                btnSiguiente.onclick = siguientePreguntaDemo;
                // Deshabilitar inicialmente
                btnSiguiente.disabled = true;
                btnSiguiente.style.opacity = '0.5';
                btnSiguiente.style.cursor = 'not-allowed';
            }
        }
        
        function empezarQuizDemo() {
            document.querySelector('#quiz #bienvenida').classList.remove('active');
            document.querySelector('#quiz #pregunta').classList.add('active');
            mostrarPreguntaDemo();
            iniciarAudio();
        }
        
        function mostrarPreguntaDemo() {
            if (preguntaActual >= preguntasDemo.length) {
                mostrarResultadosDemo();
                return;
            }
            
            const pregunta = preguntasDemo[preguntaActual];
            
            // Actualizar n√∫mero de pregunta
            document.querySelector('#quiz .numero-pregunta').textContent = preguntaActual + 1;
            
            // Actualizar texto de pregunta
            document.querySelector('#quiz .pregunta-texto').textContent = pregunta.pregunta;
            
            // Actualizar opciones
            const botonesOpciones = document.querySelectorAll('#quiz .opcion-btn');
            botonesOpciones[0].querySelector('.texto').textContent = pregunta.opciones.A;
            botonesOpciones[1].querySelector('.texto').textContent = pregunta.opciones.B;
            botonesOpciones[2].querySelector('.texto').textContent = pregunta.opciones.C;
            
            // Limpiar clases previas
            botonesOpciones.forEach(btn => {
                btn.classList.remove('correcta', 'incorrecta', 'disabled');
                btn.disabled = false;
            });
            
            // Agregar event listeners
            botonesOpciones.forEach(btn => {
                btn.onclick = () => seleccionarRespuestaDemo(btn.dataset.respuesta);
            });
            
            // Actualizar puntaje
            document.querySelector('#quiz .puntaje-numero').textContent = puntaje * 10;
            
            // Deshabilitar bot√≥n siguiente hasta que se responda
            const btnSiguiente = document.getElementById('btn-siguiente');
            if (btnSiguiente) {
                btnSiguiente.disabled = true;
                btnSiguiente.style.opacity = '0.5';
                btnSiguiente.style.cursor = 'not-allowed';
            }
            
            // Leer la pregunta con voz
            setTimeout(() => {
                leerTexto(pregunta.pregunta);
            }, 500);
            
            // Iniciar timer
            iniciarTimerDemo();
        }
        
        function iniciarTimerDemo() {
            tiempoRestante = 10;
            const tiempoNumero = document.querySelector('#quiz .tiempo-numero');
            const cronometroProgreso = document.querySelector('#quiz .cronometro-progreso');
            
            tiempoNumero.textContent = tiempoRestante;
            
            if (timerInterval) clearInterval(timerInterval);
            
            // Circunferencia del c√≠rculo (2 * PI * radio)
            const circunferencia = 2 * Math.PI * 45;
            cronometroProgreso.style.strokeDasharray = circunferencia;
            cronometroProgreso.style.strokeDashoffset = 0;
            
            timerInterval = setInterval(() => {
                tiempoRestante--;
                tiempoNumero.textContent = tiempoRestante;
                
                // Animar el c√≠rculo SVG
                const progreso = tiempoRestante / 10;
                const offset = circunferencia * (1 - progreso);
                cronometroProgreso.style.strokeDashoffset = offset;
                
                if (tiempoRestante <= 0) {
                    clearInterval(timerInterval);
                    seleccionarRespuestaDemo(null); // Tiempo agotado
                }
            }, 1000);
        }
        
        function seleccionarRespuestaDemo(opcionElegida) {
            clearInterval(timerInterval);
            
            // Cancelar voz si est√° hablando
            if (SPEECH_AVAILABLE && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            const pregunta = preguntasDemo[preguntaActual];
            const tiempoUsado = 10 - tiempoRestante;
            tiempos.push(tiempoUsado);
            
            const botonesOpciones = document.querySelectorAll('#quiz .opcion-btn');
            
            // Deshabilitar todas las opciones
            botonesOpciones.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });
            
            // Marcar respuesta correcta e incorrecta
            let textoRespuestaCorrecta = '';
            botonesOpciones.forEach(btn => {
                if (btn.dataset.respuesta === pregunta.correcta) {
                    btn.classList.add('correcta');
                    textoRespuestaCorrecta = btn.querySelector('.texto').textContent;
                }
                if (opcionElegida && btn.dataset.respuesta === opcionElegida && opcionElegida !== pregunta.correcta) {
                    btn.classList.add('incorrecta');
                }
            });
            
            // Leer la respuesta correcta con voz
            if (textoRespuestaCorrecta) {
                setTimeout(() => {
                    if (opcionElegida === pregunta.correcta) {
                        leerTexto('Me conoces bien');
                    } else if (opcionElegida === null) {
                        leerTexto(`Se acab√≥ el tiempo. La respuesta es: ${textoRespuestaCorrecta}`);
                    } else {
                        leerTexto(`Incorrecto. Es ${textoRespuestaCorrecta}`);
                    }
                }, 300);
            }
            
            // Verificar si es correcta
            if (opcionElegida === pregunta.correcta) {
                puntaje++;
            }
            
            respuestasUsuario.push({
                pregunta: pregunta.pregunta,
                elegida: opcionElegida,
                correcta: pregunta.correcta,
                esCorrecta: opcionElegida === pregunta.correcta
            });
            
            // Habilitar bot√≥n siguiente
            const btnSiguiente = document.getElementById('btn-siguiente');
            if (btnSiguiente) {
                btnSiguiente.disabled = false;
                btnSiguiente.style.opacity = '1';
                btnSiguiente.style.cursor = 'pointer';
            }
        }
        
        function siguientePreguntaDemo() {
            preguntaActual++;
            
            if (preguntaActual < preguntasDemo.length) {
                // Hay m√°s preguntas
                mostrarPreguntaDemo();
            } else {
                // Quiz terminado
                mostrarResultadosDemo();
            }
        }
        
        function mostrarResultadosDemo() {
            document.querySelector('#quiz #pregunta').classList.remove('active');
            document.querySelector('#quiz #resultados').classList.add('active');
            
            // Cancelar voz si est√° hablando
            if (SPEECH_AVAILABLE && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            const porcentaje = (puntaje / preguntasDemo.length) * 100;
            const puntajeFinal = puntaje * 10;
            const tiempoPromedio = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
            
            // Actualizar puntaje final
            document.querySelector('#quiz .puntaje-final-numero').textContent = puntajeFinal;
            
            // Mensaje seg√∫n puntuaci√≥n (igual que script.js)
            let mensaje;
            if (puntajeFinal >= 80) {
                mensaje = 'Felicidades, me conoces m√°s de lo que crees‚Ä¶ y por eso te amo a√∫n m√°s.';
            } else if (puntajeFinal >= 50) {
                mensaje = 'Vas bien, todav√≠a nos queda toda una vida para conocernos mejor.';
            } else {
                mensaje = 'No importa el puntaje, lo importante es que te amo.';
            }
            
            document.querySelector('#quiz .mensaje-resultado').textContent = mensaje;
            
            // Leer resultados con voz
            setTimeout(() => {
                leerTexto(`Has obtenido ${puntajeFinal} puntos. ${mensaje}`);
            }, 500);
            
            pararAudio();
        }
        
        function reiniciarQuizDemo() {
            preguntaActual = 0;
            puntaje = 0;
            tiempos = [];
            respuestasUsuario = [];
            
            document.querySelector('#quiz #resultados').classList.remove('active');
            document.querySelector('#quiz #bienvenida').classList.add('active');
        }
        
        function iniciarAudio() {
            const audio = document.getElementById('audio-quiz');
            if (audio) {
                audio.volume = 0.3;
                audio.loop = true;
                audio.play().catch(err => console.log('Audio bloqueado por el navegador'));
            }
        }
        
        function pararAudio() {
            const audio = document.getElementById('audio-quiz');
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
        }
        
        /* ================================================
           SCRIPTS CREAR PREGUNTAS - Gesti√≥n de preguntas personalizadas
           ================================================ */
        
        let usuarioActual = null;
        let quizCode = null;
        
        // Funci√≥n para esperar a que supabaseQuiz est√© disponible
        function esperarSupabase(callback) {
            console.log('‚è≥ Esperando supabaseQuiz...');
            if (window.supabaseQuiz) {
                console.log('‚úÖ supabaseQuiz encontrado');
                callback();
            } else {
                setTimeout(() => esperarSupabase(callback), 50);
            }
        }
        
        // Funci√≥n para inicializar la secci√≥n crear-preguntas
        function inicializarCrearPreguntas() {
            console.log('üöÄ Inicializando crear-preguntas');
            console.log('üì¶ window.supabase:', typeof window.supabase);
            console.log('üì¶ window.supabaseQuiz:', typeof window.supabaseQuiz);
            
            esperarSupabase(async () => {
                console.log('üîç Iniciando verificaci√≥n de acceso...');
                
                // Verificar que supabaseQuiz est√° disponible
                if (!window.supabaseQuiz) {
                    console.error('‚ùå supabaseQuiz no est√° disponible');
                    mostrarErrorAcceso('Error de configuraci√≥n. Recarga la p√°gina.');
                    return;
                }
                console.log('‚úÖ supabaseQuiz disponible');
                
                // Obtener quiz_code con prioridad: sessionStorage > URL query > hash
                quizCode = sessionStorage.getItem('currentQuizCode');
                console.log('üìù Quiz code desde sessionStorage:', quizCode);
                
                // Si no est√° en sessionStorage, buscar en URL
                if (!quizCode) {
                    const urlParams = new URLSearchParams(window.location.search);
                    quizCode = urlParams.get('code');
                    console.log('üìù Quiz code desde URL query:', quizCode);
                }
                
                // Si no est√° en query, buscar en hash
                if (!quizCode && window.location.hash.includes('?')) {
                    const hashParams = new URLSearchParams(window.location.hash.split('?')[1]);
                    quizCode = hashParams.get('code');
                    console.log('üìù Quiz code desde hash:', quizCode);
                }
                
                console.log('üìù Quiz code final:', quizCode);
                
                if (!quizCode) {
                    mostrarErrorAcceso('No se proporcion√≥ un c√≥digo de quiz v√°lido.');
                    return;
                }
                
                // Guardar en sessionStorage para futuros accesos
                sessionStorage.setItem('currentQuizCode', quizCode);
                
                // Verificar que el usuario existe y est√° activo
                try {
                    console.log('üîé Buscando usuario con c√≥digo:', quizCode);
                    const { data, error } = await supabaseQuiz.client
                        .from('usuarios')
                        .select('*')
                        .eq('quiz_code', quizCode)
                        .maybeSingle();
                    
                    console.log('üìä Respuesta de Supabase - data:', data, 'error:', error);
                    
                    if (error || !data) {
                        console.error('‚ùå Error o usuario no encontrado:', error);
                        mostrarErrorAcceso('C√≥digo de quiz no encontrado.');
                        return;
                    }
                    
                    if (!data.activo) {
                        console.log('‚è≥ Usuario encontrado pero no activo');
                        mostrarErrorAcceso('Tu pago a√∫n no ha sido verificado. Te notificaremos por email cuando est√© aprobado.');
                        return;
                    }
                    
                    console.log('‚úÖ Usuario v√°lido y activo:', data.nombre);
                    usuarioActual = data;
                    
                    // Verificar si ya cre√≥ sus preguntas
                    console.log('üîé Verificando si ya tiene preguntas...');
                    const { data: preguntasExistentes, error: errorPreguntas } = await supabaseQuiz.client
                        .from('preguntas_personalizadas')
                        .select('id')
                        .eq('usuario_id', usuarioActual.id);
                    
                    console.log('üìä Preguntas existentes:', preguntasExistentes, 'error:', errorPreguntas);
                    
                    if (preguntasExistentes && preguntasExistentes.length > 0) {
                        console.log('‚úÖ Ya tiene preguntas, mostrando link');
                        mostrarLinkFinal();
                    } else {
                        console.log('üìù No tiene preguntas, creando formulario');
                        crearFormularioPreguntas();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error verificando acceso:', error);
                    mostrarErrorAcceso('Error al verificar el acceso. Intenta de nuevo m√°s tarde.');
                }
            });
        }
        
        function mostrarErrorAcceso(mensaje) {
            document.getElementById('loadingInicial').classList.remove('show');
            document.getElementById('errorAccesoTexto').textContent = mensaje;
            document.getElementById('errorAcceso').classList.add('show');
            // Limpiar c√≥digo del sessionStorage si hay error de acceso
            sessionStorage.removeItem('currentQuizCode');
        }
        
        function crearFormularioPreguntas() {
            document.getElementById('loadingInicial').classList.remove('show');
            document.getElementById('formularioPreguntas').style.display = 'block';
            
            const container = document.getElementById('preguntasContainer');
            container.innerHTML = ''; // Limpiar contenedor
            
            for (let i = 1; i <= 10; i++) {
                const card = document.createElement('div');
                card.className = 'pregunta-card';
                card.innerHTML = `
                    <div class="pregunta-numero">${i}</div>
                    
                    <div class="form-group">
                        <label>Pregunta ${i} *</label>
                        <textarea id="pregunta-${i}" required placeholder="Ej: ¬øCu√°l es mi color favorito?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Opciones de Respuesta</label>
                        <div class="opciones-grid">
                            <div class="opcion-group">
                                <div class="opcion-label">A</div>
                                <input type="text" id="opcion-${i}-a" class="opcion-input" required placeholder="Primera opci√≥n">
                            </div>
                            <div class="opcion-group">
                                <div class="opcion-label">B</div>
                                <input type="text" id="opcion-${i}-b" class="opcion-input" required placeholder="Segunda opci√≥n">
                            </div>
                            <div class="opcion-group">
                                <div class="opcion-label">C</div>
                                <input type="text" id="opcion-${i}-c" class="opcion-input" required placeholder="Tercera opci√≥n">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Respuesta Correcta *</label>
                        <div class="correcta-select">
                            <div class="radio-option">
                                <input type="radio" id="correcta-${i}-a" name="correcta-${i}" value="A" required>
                                <label for="correcta-${i}-a">A</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="correcta-${i}-b" name="correcta-${i}" value="B">
                                <label for="correcta-${i}-b">B</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="correcta-${i}-c" name="correcta-${i}" value="C">
                                <label for="correcta-${i}-c">C</label>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Agregar listener para actualizar progreso
                const inputs = card.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    input.addEventListener('input', actualizarProgreso);
                });
            }
            
            // Configurar submit del formulario
            document.getElementById('formPreguntas').onsubmit = guardarPreguntas;
        }
        
        function actualizarProgreso() {
            let completadas = 0;
            
            for (let i = 1; i <= 10; i++) {
                const pregunta = document.getElementById(`pregunta-${i}`)?.value.trim();
                const opcionA = document.getElementById(`opcion-${i}-a`)?.value.trim();
                const opcionB = document.getElementById(`opcion-${i}-b`)?.value.trim();
                const opcionC = document.getElementById(`opcion-${i}-c`)?.value.trim();
                const correcta = document.querySelector(`input[name="correcta-${i}"]:checked`);
                
                if (pregunta && opcionA && opcionB && opcionC && correcta) {
                    completadas++;
                }
            }
            
            const porcentaje = (completadas / 10) * 100;
            document.getElementById('progressBar').style.width = porcentaje + '%';
            document.getElementById('progressText').textContent = `${completadas} de 10 completadas`;
        }
        
        async function guardarPreguntas(e) {
            e.preventDefault();
            
            const btnGuardar = document.getElementById('btnGuardar');
            btnGuardar.disabled = true;
            btnGuardar.textContent = 'Guardando...';
            
            try {
                // Obtener nombre del destinatario
                const nombreDestinatario = document.getElementById('nombre-destinatario').value.trim();
                
                // Actualizar el nombre del destinatario en la tabla usuarios
                await supabaseQuiz.client
                    .from('usuarios')
                    .update({ nombre_destinatario: nombreDestinatario })
                    .eq('id', usuarioActual.id);
                
                const preguntas = [];
                
                for (let i = 1; i <= 10; i++) {
                    const pregunta = document.getElementById(`pregunta-${i}`).value.trim();
                    const opcionA = document.getElementById(`opcion-${i}-a`).value.trim();
                    const opcionB = document.getElementById(`opcion-${i}-b`).value.trim();
                    const opcionC = document.getElementById(`opcion-${i}-c`).value.trim();
                    const correcta = document.querySelector(`input[name="correcta-${i}"]:checked`).value;
                    
                    preguntas.push({
                        pregunta: pregunta,
                        opciones: {
                            A: opcionA,
                            B: opcionB,
                            C: opcionC
                        },
                        correcta: correcta
                    });
                }
                
                const guardado = await supabaseQuiz.guardarPreguntasPersonalizadas(usuarioActual.id, preguntas);
                
                if (guardado) {
                    console.log('‚úÖ Preguntas guardadas exitosamente');
                    mostrarLinkFinal();
                } else {
                    throw new Error('No se pudieron guardar las preguntas');
                }
                
            } catch (error) {
                console.error('Error guardando preguntas:', error);
                alert('Hubo un error al guardar las preguntas. Por favor intenta de nuevo.');
                btnGuardar.disabled = false;
                btnGuardar.textContent = 'Guardar Quiz y Obtener Link üéâ';
            }
        }
        
        function mostrarLinkFinal() {
            document.getElementById('loadingInicial').classList.remove('show');
            const baseURL = window.location.origin + window.location.pathname.replace('index.html', '');
            const linkCompleto = `${baseURL}index.html#quiz?code=${quizCode}`;
            
            document.getElementById('formularioPreguntas').style.display = 'none';
            document.getElementById('linkFinal').textContent = linkCompleto;
            document.getElementById('successScreen').classList.add('show');
        }
        
        function copiarLink() {
            const link = document.getElementById('linkFinal').textContent;
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ Link copiado al portapapeles');
            }).catch(() => {
                alert('No se pudo copiar. Link: ' + link);
            });
        }
        
        function compartirWhatsApp() {
            const link = document.getElementById('linkFinal').textContent;
            const mensaje = `üéÅ ¬°Hola! Prepar√© un quiz especial para ti.\n\nüîó Resp√≥ndelo aqu√≠: ${link}\n\n¬øQu√© tanto me conoces? üíï`;
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
            window.open(whatsappURL, '_blank');
        }
        
        /* ================================================
           SCRIPTS REGISTRO - Gesti√≥n de registro de usuarios
           ================================================ */
        
        let datosUsuarioReg = {};
        let archivoComprobanteReg = null;
        
        // Funci√≥n para inicializar la secci√≥n de registro
        function inicializarRegistro() {
            console.log('üöÄ Inicializando registro');
            
            // Resetear formulario
            datosUsuarioReg = {};
            archivoComprobanteReg = null;
            
            // Limpiar campos
            const nombreInput = document.getElementById('nombre-reg');
            const emailInput = document.getElementById('email-reg');
            const metodoPagoSelect = document.getElementById('metodo-pago-reg');
            const numeroOperacionInput = document.getElementById('numero-operacion-reg');
            const comprobanteInput = document.getElementById('comprobante-reg');
            const fileNameDiv = document.getElementById('fileName-reg');
            
            if (nombreInput) nombreInput.value = '';
            if (emailInput) emailInput.value = '';
            if (metodoPagoSelect) metodoPagoSelect.value = '';
            if (numeroOperacionInput) numeroOperacionInput.value = '';
            if (comprobanteInput) comprobanteInput.value = '';
            if (fileNameDiv) fileNameDiv.textContent = 'JPG, PNG - M√°x 5MB';
            
            // Volver al paso 1
            cambiarPasoReg(1);
            
            // Configurar event listeners
            const formDatos = document.getElementById('form-datos-reg');
            if (formDatos) {
                formDatos.onsubmit = function(e) {
                    e.preventDefault();
                    
                    datosUsuarioReg.nombre = document.getElementById('nombre-reg').value.trim();
                    datosUsuarioReg.email = document.getElementById('email-reg').value.trim();
                    
                    if (!datosUsuarioReg.nombre || !datosUsuarioReg.email) {
                        mostrarError('errorMessageReg', 'Por favor completa todos los campos');
                        return;
                    }
                    
                    cambiarPasoReg(2);
                };
            }
            
            const comprobanteInputEl = document.getElementById('comprobante-reg');
            if (comprobanteInputEl) {
                comprobanteInputEl.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            mostrarError('errorMessageReg', 'El archivo es muy grande. M√°ximo 5MB');
                            e.target.value = '';
                            return;
                        }
                        archivoComprobanteReg = file;
                        document.getElementById('fileName-reg').textContent = file.name;
                    }
                };
            }
            
            const formPago = document.getElementById('form-pago-reg');
            if (formPago) {
                formPago.onsubmit = async function(e) {
                    e.preventDefault();
                    
                    const metodoPago = document.getElementById('metodo-pago-reg').value;
                    const numeroOperacion = document.getElementById('numero-operacion-reg').value.trim();
                    
                    if (!metodoPago || !numeroOperacion || !archivoComprobanteReg) {
                        mostrarError('errorMessageReg', 'Por favor completa todos los campos y sube el comprobante');
                        return;
                    }
                    
                    datosUsuarioReg.metodoPago = metodoPago;
                    datosUsuarioReg.numeroOperacion = numeroOperacion;
                    
                    // Registrar usuario
                    await registrarUsuarioReg();
                };
            }
        }
        
        async function registrarUsuarioReg() {
            toggleLoading('loadingReg', true);
            ocultarError('errorMessageReg');
            
            try {
                // Generar c√≥digo √∫nico
                const quizCode = await supabaseQuiz.generarCodigoUnico();
                
                if (!quizCode) {
                    throw new Error('No se pudo generar el c√≥digo del quiz');
                }
                
                // Subir comprobante a Supabase Storage
                let comprobanteUrl = null;
                try {
                    const fileName = `${quizCode}_${Date.now()}.${archivoComprobanteReg.name.split('.').pop()}`;
                    const { data, error } = await supabaseQuiz.client.storage
                        .from('comprobantes')
                        .upload(fileName, archivoComprobanteReg);
                    
                    if (error) throw error;
                    
                    // Obtener URL p√∫blica
                    const { data: urlData } = supabaseQuiz.client.storage
                        .from('comprobantes')
                        .getPublicUrl(fileName);
                    
                    comprobanteUrl = urlData.publicUrl;
                } catch (storageError) {
                    console.warn('Error subiendo comprobante a storage:', storageError);
                    comprobanteUrl = 'pendiente_subida';
                }
                
                // Crear usuario en base de datos
                const usuario = await supabaseQuiz.crearUsuario({
                    nombre: datosUsuarioReg.nombre,
                    email: datosUsuarioReg.email,
                    quizCode: quizCode,
                    metodoPago: datosUsuarioReg.metodoPago,
                    numeroOperacion: datosUsuarioReg.numeroOperacion,
                    comprobanteUrl: comprobanteUrl
                });
                
                if (!usuario) {
                    throw new Error('No se pudo crear el usuario');
                }
                
                console.log('‚úÖ Usuario registrado:', usuario);
                
                toggleLoading('loadingReg', false);
                cambiarPasoReg(3);
                
            } catch (error) {
                console.error('‚ùå Error registrando usuario:', error);
                mostrarError('errorMessageReg', 'Hubo un error al procesar tu registro: ' + error.message);
                toggleLoading('loadingReg', false);
            }
        }
        
        function cambiarPasoReg(paso) {
            // Ocultar todas las secciones
            document.querySelectorAll('#registro .form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar secci√≥n actual
            document.getElementById('paso' + paso + '-reg').classList.add('active');
            
            // Actualizar indicadores
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById('step' + i + '-indicator-reg');
                indicator.classList.remove('active', 'complete');
                
                if (i < paso) {
                    indicator.classList.add('complete');
                } else if (i === paso) {
                    indicator.classList.add('active');
                }
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function volverPaso1Reg() {
            cambiarPasoReg(1);
        }
        
        function irALoginDesdeRegistro() {
            mostrarSeccion('login');
        }
        
        /* ================================================
           SCRIPTS LOGIN - Gesti√≥n de inicio de sesi√≥n
           ================================================ */
        
        // Funci√≥n para inicializar la secci√≥n de login
        function inicializarLogin() {
            console.log('üöÄ Inicializando login');
            
            // Limpiar campo
            const emailInput = document.getElementById('email-login');
            if (emailInput) emailInput.value = '';
            
            ocultarError('errorMessageLogin');
            toggleLoading('loadingLogin', false);
            
            // Configurar event listener del formulario
            const formLogin = document.getElementById('form-login');
            if (formLogin) {
                formLogin.onsubmit = async function(e) {
                    e.preventDefault();
                    await procesarLogin();
                };
            }
        }
        
        async function procesarLogin() {
            const email = document.getElementById('email-login').value.trim();
            
            // Validar que el email est√© lleno
            if (!email) {
                mostrarError('errorMessageLogin', 'Por favor ingresa tu correo electr√≥nico');
                return;
            }
            
            toggleLoading('loadingLogin', true);
            ocultarError('errorMessageLogin');
            
            try {
                // Buscar usuario por email
                console.log('üîé Buscando usuario por email:', email);
                const { data: usuario, error } = await supabaseQuiz.client
                    .from('usuarios')
                    .select('*')
                    .eq('email', email)
                    .maybeSingle();
                
                if (error) {
                    console.error('‚ùå Error en la consulta:', error);
                }
                
                if (usuario) {
                    console.log('‚úÖ Usuario encontrado por email');
                } else {
                    console.log('‚ùå No se encontr√≥ usuario con ese email');
                }
                
                // Validar si se encontr√≥ el usuario
                if (!usuario) {
                    toggleLoading('loadingLogin', false);
                    mostrarError('errorMessageLogin', 'No se encontr√≥ una cuenta con ese correo. Verifica e intenta de nuevo.');
                    return;
                }
                
                // Verificar si el usuario est√° activo
                if (!usuario.activo) {
                    toggleLoading('loadingLogin', false);
                    mostrarError('errorMessageLogin', 'Tu pago a√∫n no ha sido verificado. Te notificaremos por email cuando est√© aprobado.');
                    return;
                }
                
                console.log('‚úÖ Login exitoso:', usuario.nombre);
                
                // Login exitoso - redirigir a crear preguntas
                toggleLoading('loadingLogin', false);
                
                // Guardar c√≥digo en sessionStorage para acceso inmediato
                sessionStorage.setItem('currentQuizCode', usuario.quiz_code);
                
                // Actualizar URL con el c√≥digo (el evento hashchange manejar√° la navegaci√≥n)
                window.location.hash = `crear-preguntas?code=${usuario.quiz_code}`;
                
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                toggleLoading('loadingLogin', false);
                mostrarError('errorMessageLogin', 'Hubo un error al verificar tus datos. Intenta de nuevo.');
            }
        }
    </script>

</body>
</html>
